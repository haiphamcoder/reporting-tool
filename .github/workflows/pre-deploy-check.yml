name: Pre-deploy Check

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  code-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Java
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Check Java code formatting
      run: |
        echo "Checking Java code formatting..."
        # Add your Java code formatting check here
        # Example: mvn spotless:check
        
    - name: Check Dockerfile syntax
      run: |
        echo "Checking Dockerfile syntax..."
        for dockerfile in $(find . -name "Dockerfile*"); do
          echo "Checking $dockerfile"
          docker run --rm -i hadolint/hadolint < "$dockerfile" || true
        done
        
    - name: Check docker-compose syntax
      run: |
        echo "Checking docker-compose syntax..."
        docker compose -f docker-compose.prod.yml config
        
    - name: Check for sensitive data
      run: |
        echo "Checking for sensitive data in code..."
        # Check for hardcoded passwords, API keys, etc.
        if grep -r "password.*=" . --exclude-dir=.git --exclude-dir=node_modules --exclude-dir=target; then
          echo "Warning: Found potential hardcoded passwords"
        fi
        
    - name: Check file permissions
      run: |
        echo "Checking file permissions..."
        chmod +x scripts/deploy.sh
        
    - name: Check required files exist
      run: |
        echo "Checking required files exist..."
        required_files=(
          "docker-compose.prod.yml"
          "Makefile"
          "scripts/deploy.sh"
          "scripts/test-connection.sh"
          "frontend/package.json"
          "frontend/package-lock.json"
        )
        
        for file in "${required_files[@]}"; do
          if [ -f "$file" ]; then
            echo "✅ $file exists"
          else
            echo "❌ $file missing"
            exit 1
          fi
        done
        
    - name: Summary
      run: |
        echo "✅ Pre-deploy checks completed"
        echo "Code is ready for deployment" 